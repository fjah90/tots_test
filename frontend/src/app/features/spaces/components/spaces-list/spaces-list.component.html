<p-toast></p-toast>

<div class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors">
  <!-- Header Section -->
  <div class="bg-gradient-to-r from-teal-500 to-teal-600 text-white py-12 px-6">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-4xl font-bold mb-2">Encuentra tu Espacio Ideal</h1>
      <p class="text-teal-100 text-lg">Reserva salas de reuniones, auditorios y espacios de trabajo</p>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="max-w-7xl mx-auto px-6 -mt-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 transition-colors">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        
        <!-- Búsqueda por texto -->
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Buscar</label>
          <input 
            type="text" 
            pInputText 
            placeholder="Nombre, ubicación..." 
            [ngModel]="searchTerm()"
            (ngModelChange)="searchTerm.set($event)"
            class="w-full"
          />
        </div>

        <!-- Filtro por fecha -->
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
            Fecha de Reserva
            <i class="pi pi-info-circle ml-1 text-gray-400" 
               pTooltip="Filtra espacios con disponibilidad en esta fecha"></i>
          </label>
          <p-datepicker 
            [ngModel]="selectedDate()"
            (ngModelChange)="onDateChange($event)"
            [showIcon]="true"
            [minDate]="minDate"
            dateFormat="dd/mm/yy"
            placeholder="Seleccionar fecha"
            styleClass="w-full"
          />
        </div>

        <!-- Filtro por capacidad -->
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
            Capacidad: {{ capacityRange()[0] }} - {{ capacityRange()[1] === 100 ? '100+' : capacityRange()[1] }} personas
          </label>
          <p-slider 
            [ngModel]="capacityRange()"
            (ngModelChange)="capacityRange.set($event)"
            [range]="true"
            [min]="0"
            [max]="100"
            [step]="5"
            styleClass="mt-4"
          />
        </div>

        <!-- Botón limpiar filtros -->
        <div class="flex flex-col justify-end">
          <p-button 
            label="Limpiar Filtros" 
            icon="pi pi-filter-slash" 
            severity="secondary"
            [outlined]="true"
            (click)="clearFilters()"
          />
        </div>
      </div>

      <!-- Resultados count -->
      <p-divider />
      <div class="flex justify-between items-center">
        <span class="text-gray-600 dark:text-gray-400">
          <strong>{{ filteredSpaces().length }}</strong> de <strong>{{ totalItems() }}</strong> espacios
          @if (hasMore()) {
            <span class="text-sm text-gray-400"> (scroll para ver más)</span>
          }
        </span>
      </div>
    </div>
  </div>

  <!-- Spaces Grid -->
  <div class="max-w-7xl mx-auto px-6 py-8">
    @if (loading()) {
      <div class="flex justify-center items-center py-20">
        <p-progressSpinner strokeWidth="4" />
      </div>
    } @else if (filteredSpaces().length === 0) {
      <div class="text-center py-20">
        <i class="pi pi-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No se encontraron espacios</h3>
        <p class="text-gray-500 dark:text-gray-500">Intenta ajustar los filtros de búsqueda</p>
        <p-button 
          label="Limpiar Filtros" 
          icon="pi pi-refresh" 
          class="mt-4"
          (click)="clearFilters()" 
        />
      </div>
    } @else {
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        @for (space of filteredSpaces(); track space.id) {
          <p-card styleClass="space-card hover:shadow-xl transition-shadow duration-300 dark:bg-gray-800">
            <!-- Image Carousel or Single Image -->
            <ng-template #header>
              <div class="relative h-48 overflow-hidden group">
                @if (getSpaceImages(space).length > 1) {
                  <!-- Multiple images: Carousel -->
                  <div class="space-image-carousel h-full">
                    <p-carousel 
                      [value]="getSpaceImages(space)" 
                      [numVisible]="1" 
                      [numScroll]="1"
                      [circular]="true"
                      [showNavigators]="true"
                      [showIndicators]="false"
                      [autoplayInterval]="0">
                      <ng-template #item let-imageUrl>
                        <img 
                          [src]="imageUrl" 
                          [alt]="space.name"
                          class="carousel-image"
                        />
                      </ng-template>
                    </p-carousel>
                    <!-- Indicador de cantidad de imágenes -->
                    <div class="image-count">
                      <i class="pi pi-images"></i>
                      {{ getSpaceImages(space).length }}
                    </div>
                  </div>
                } @else if (getSpaceImages(space).length === 1) {
                  <!-- Single image -->
                  <img 
                    [src]="getSpaceImages(space)[0]" 
                    [alt]="space.name"
                    class="w-full h-full object-cover"
                  />
                } @else {
                  <!-- No image: placeholder -->
                  <div class="w-full h-full bg-gradient-to-br from-teal-400 to-teal-500 flex items-center justify-center">
                    <i class="pi pi-building text-white text-5xl"></i>
                  </div>
                }
                <p-tag 
                  [value]="space.is_active ? 'Disponible' : 'No Disponible'"
                  [severity]="space.is_active ? 'success' : 'danger'"
                  styleClass="absolute top-3 right-3 z-10"
                />
              </div>
            </ng-template>

            <!-- Content - Estructura fija -->
            <div class="card-content">
              <!-- Título - altura fija -->
              <h3 class="card-title text-xl font-bold text-gray-800 dark:text-gray-100">{{ space.name }}</h3>
              
              <!-- Descripción - altura fija con 2 líneas -->
              <p class="card-description text-gray-600 dark:text-gray-400 text-sm">
                {{ space.description || 'Sin descripción disponible' }}
              </p>

              <!-- Info: Capacidad y Ubicación - altura fija -->
              <div class="card-info flex flex-wrap gap-3 text-sm text-gray-500 dark:text-gray-400">
                <span class="flex items-center gap-1">
                  <i [class]="getCapacityIcon(space.capacity)"></i>
                  {{ space.capacity }} personas
                </span>
                <span class="flex items-center gap-1">
                  <i class="pi pi-map-marker"></i>
                  {{ space.location || 'Sin ubicación' }}
                </span>
              </div>

              <!-- Amenities - altura fija -->
              <div class="card-amenities flex flex-wrap gap-1">
                @if (space.amenities && space.amenities.length > 0) {
                  @for (amenity of space.amenities.slice(0, 3); track amenity) {
                    <p-tag [value]="amenity" severity="secondary" />
                  }
                  @if (space.amenities.length > 3) {
                    <p-tag [value]="'+' + (space.amenities.length - 3)" severity="info" />
                  }
                } @else {
                  <p-tag value="Sin amenidades" severity="secondary" />
                }
              </div>
            </div>

            <!-- Footer -->
            <ng-template #footer>
              <div class="flex gap-2">
                <p-button 
                  label="Ver Detalles" 
                  icon="pi pi-eye" 
                  severity="secondary"
                  [outlined]="true"
                  [routerLink]="['/spaces', space.id]"
                  class="flex-1"
                />
                <p-button 
                  label="Reservar" 
                  icon="pi pi-calendar-plus"
                  (click)="openReservationModal(space)"
                  class="flex-1"
                  [disabled]="!space.is_active"
                />
              </div>
            </ng-template>
          </p-card>
        }
      </div>

      <!-- Infinite Scroll Loading Indicator -->
      @if (loadingMore()) {
        <div class="flex justify-center items-center py-8">
          <p-progressSpinner strokeWidth="4" [style]="{ width: '40px', height: '40px' }" />
          <span class="ml-3 text-gray-600 dark:text-gray-400">Cargando más espacios...</span>
        </div>
      }

      <!-- End of Results Message -->
      @if (!hasMore() && filteredSpaces().length > 0) {
        <div class="text-center py-6 text-gray-500 dark:text-gray-400">
          <i class="pi pi-check-circle text-2xl text-teal-500 mb-2"></i>
          <p>Has visto todos los espacios disponibles</p>
        </div>
      }
    }
  </div>
</div>

<!-- Reservation Dialog Modal -->
<p-dialog 
  [header]="'Reservar: ' + (selectedSpace()?.name || '')"
  [(visible)]="showReservationDialogVisible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '500px' }"
  (onHide)="closeReservationModal()"
>
  @if (selectedSpace()) {
    <app-reservation-form
      [space]="selectedSpace()!"
      [preselectedDate]="selectedDate()"
      (success)="onReservationSuccess()"
      (error)="onReservationError($event)"
      (cancel)="closeReservationModal()"
    />
  }
</p-dialog>
